<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Translate - 任务详情</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-2: #0b1220;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #3b82f6;
      --primary-2: #2563eb;
      --border: #1f2937;
      --success: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0%, transparent 70%),
                  radial-gradient(1200px 600px at 120% 0%, #0b1220 0%, #0b1220 60%);
    }
    .container{max-width:980px;margin:48px auto;padding:0 16px}
    .card{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .title{font-size:20px;font-weight:700}
    .sub{color:var(--muted);font-size:13px}
    .card-body{padding:20px 24px}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:720px){ .grid-2{grid-template-columns:1fr 1fr} }
    label{display:block;font-weight:600;margin-bottom:8px}
    .row{
      background: rgba(255,255,255,.02);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 14px 10px;
    }
    input[type="text"], input[type="password"]{
      width:100%;
      padding:12px 12px;
      background:#0b1020;
      border:1px solid #182034;
      border-radius:8px;
      color:var(--text);
      outline:none;
      transition:.2s border-color, .2s box-shadow;
    }
    input[type="text"]:focus, input[type="password"]:focus{
      border-color:#355399; box-shadow:0 0 0 3px rgba(53,83,153,.2)
    }
    .checkbox{display:flex; align-items:center; gap:8px; margin-top:8px; color:var(--muted); font-size:14px}
    .actions{display:flex; gap:12px; margin-top:12px; flex-wrap:wrap}
    .btn{
      appearance:none; border:none; cursor:pointer;
      background: var(--primary);
      color:#fff; padding:10px 14px; border-radius:10px; font-weight:700;
      box-shadow: 0 10px 20px rgba(37,99,235,.25);
      transition: transform .06s ease, background .2s ease;
    }
    .btn:hover{ background: var(--primary-2) }
    .btn.secondary{ background: transparent; color: var(--text); border:1px solid #2a3554; box-shadow:none }
    .btn.warn{ background: #f59e0b }
    .btn.success{ background: #22c55e }
    .hint{color:var(--muted); font-size:13px}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--border);
      border-radius:12px; overflow:hidden;
      background:#0b1020;
    }
    thead th{
      background:#0f1526; color:#c7d2fe; text-align:left; font-weight:700; padding:12px 14px; border-bottom:1px solid var(--border)
    }
    tbody td{
      padding:12px 14px; border-bottom:1px solid #15203a; vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:none}
    .badge{
      display:inline-block; padding:4px 8px; background:#172039; border:1px solid #2a3554; color:#c7d2fe; border-radius:999px; font-size:12px; margin:2px 6px 2px 0
    }
    .state{
      font-weight:700; padding:4px 8px; border-radius:8px; display:inline-block
    }
    .state.done{ color:#22c55e; background:rgba(34,197,94,.08); border:1px solid rgba(34,197,94,.25) }
    .state.ing{ color:#93c5fd; background:rgba(59,130,246,.08); border:1px solid rgba(59,130,246,.25) }
    .state.pack{ color:#fcd34d; background:rgba(245,158,11,.08); border:1px solid rgba(245,158,11,.25) }
    .state.wait{ color:#a7f3d0; background:rgba(16,185,129,.08); border:1px solid rgba(16,185,129,.25) }
    .state.timeout{ color:#fca5a5; background:rgba(239,68,68,.08); border:1px solid rgba(239,68,68,.25) }

    .toolbar{display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:12px}
    code{background:#0b1020;border:1px solid #182034;color:#cbd5e1;padding:2px 6px;border-radius:6px}
    .spinner{
      width:16px;height:16px;border:3px solid #2a3554;border-top-color:#3b82f6;border-radius:50%;display:inline-block;animation:spin .9s linear infinite;vertical-align:-3px;margin-right:6px
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-head">
        <div>
          <div class="title">AI Translate · 任务详情</div>
          <div class="sub" id="taskTitle">任务 id：<code>-</code></div>
        </div>
        <div>
          <a class="btn secondary" href="index.html">返回创建</a>
        </div>
      </div>

      <div class="card-body">
        <form id="configForm" autocomplete="off">
          <div class="grid grid-2">
            <div class="row">
              <label for="apiUrl">API URL</label>
              <input type="text" id="apiUrl" name="api-url" placeholder="https://example.com/ai-translate" />
              <div class="checkbox">
                <input type="checkbox" id="rememberUrl" />
                <label for="rememberUrl" style="margin:0; font-weight:500;">记住 URL</label>
              </div>
            </div>
            <div class="row">
              <label for="apiKey">API Key</label>
              <input type="password" id="apiKey" name="api-key" placeholder="在此输入 API Key" autocomplete="new-password" />
              <div class="checkbox">
                <input type="checkbox" id="rememberKey" />
                <label for="rememberKey" style="margin:0; font-weight:500;">记住 Key</label>
              </div>
            </div>
          </div>

          <div class="actions">
            <button type="submit" class="btn">加载任务</button>
            <span class="hint">页面加载时会自动查询，修改 URL/Key 后可手动重新加载</span>
          </div>
        </form>

        <div style="height:12px"></div>

        <div class="toolbar">
          <div id="statusBar" class="hint"></div>
          <div id="actionArea"></div>
        </div>

        <table id="resultTable" aria-label="任务状态表">
          <thead>
            <tr>
              <th style="width:180px">状态</th>
              <th>命名空间</th>
              <th style="width:140px">词条数</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="tdStatus">—</td>
              <td id="tdNamespaces">—</td>
              <td id="tdStrings">—</td>
            </tr>
          </tbody>
        </table>

      </div>
    </div>
  </div>

  <script>
    // Cookie helpers
    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days*864e5).toUTCString();
      document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value) +
        "; expires=" + expires + "; path=/ai-translate/; SameSite=Lax";
    }
    function getCookie(name) {
      const m = document.cookie.match(new RegExp('(?:^|; )' + encodeURIComponent(name).replace(/[-.+*]/g, '\\$&') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : null;
    }
    function deleteCookie(name) {
      document.cookie = encodeURIComponent(name) + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/ai-translate/; SameSite=Lax";
    }

    // Elements
    const apiUrlInput = document.getElementById('apiUrl');
    const apiKeyInput = document.getElementById('apiKey');
    const rememberUrl = document.getElementById('rememberUrl');
    const rememberKey = document.getElementById('rememberKey');
    const taskTitle = document.getElementById('taskTitle');
    const statusBar = document.getElementById('statusBar');
    const actionArea = document.getElementById('actionArea');

    const tdStatus = document.getElementById('tdStatus');
    const tdNamespaces = document.getElementById('tdNamespaces');
    const tdStrings = document.getElementById('tdStrings');

    // Restore cookies and default URL
    (function restore(){
      const cu = getCookie('ai_url');
      const ck = getCookie('ai_key');
      apiUrlInput.value = cu || 'https://mc-api.syshub.top/ai-translate';
      if (cu) rememberUrl.checked = true;
      if (ck) { apiKeyInput.value = ck; rememberKey.checked = true; }
    })();

    // Read taskid
    const params = new URLSearchParams(location.search);
    const taskid = params.get('id') || '';
    taskTitle.innerHTML = '任务 id：<code>' + (taskid ? escapeHtml(taskid) : '（未提供）') + '</code>';

    // Auto load on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      if (taskid) loadTask();
    });

    // Manual reload
    document.getElementById('configForm').addEventListener('submit', (e) => {
      e.preventDefault();
      loadTask();
    });

    async function loadTask(){
      const apiUrl = (apiUrlInput.value || '').trim().replace(/\/+$/,'');
      const apiKey = (apiKeyInput.value || '').trim();
      if (!apiUrl || !apiKey) {
        statusBar.innerHTML = '<span style="color:#fca5a5">请先填写 API URL 与 Key。</span>';
        return;
      }

      // Cookies on demand (store if checked; remove if unchecked)
      try {
        if (rememberUrl.checked) setCookie('ai_url', apiUrl, 30);
        else deleteCookie('ai_url');
        if (rememberKey.checked) setCookie('ai_key', apiKey, 30);
        else deleteCookie('ai_key');
      } catch {}

      setLoading(true, '正在获取任务状态...');
      clearTable();

      try {
        const res = await fetch(`${apiUrl}/${encodeURIComponent(taskid)}`, {
          method: 'GET',
          headers: { 'X-Api-Key': apiKey }
        });

        let data = null;
        try { data = await res.json(); } catch { data = {}; }

        if (!res.ok) {
          const err = (data && (data.error || data.message)) || `请求失败（HTTP ${res.status}）`;
          statusBar.innerHTML = `<span style="color:#fca5a5">错误：${escapeHtml(err)}</span>`;
          actionArea.innerHTML = `<button class="btn secondary" onclick="location.reload()">刷新</button>`;
          setLoading(false);
          return;
        }

        // Expected shape:
        // {"id":"abc12345","status":0,"namespaces":["abc","xyz"],"strings":114,"result":"qwerty666","created_at":1754651546}
        const now = Math.floor(Date.now()/1000);
        const created = Number(data.created_at || 0);
        const isTimeout = (data.status !== 0) && created && ((now - created) > 300);

        const stateInfo = getStateInfo(data.status, isTimeout);

        // Fill table
        tdStatus.innerHTML = `<span class="state ${stateInfo.cls}">${stateInfo.text}</span>`;
        tdNamespaces.innerHTML = renderNamespaces(data.namespaces);
        tdStrings.textContent = (typeof data.strings === 'number' ? data.strings : '—');

        // Action button
        if (data.status === 0 && !isTimeout) {
          const link = `https://lanzout.com/${encodeURIComponent(data.result || '')}`;
          actionArea.innerHTML = `<button class="btn success" id="downloadBtn">下载文件</button>`;
          document.getElementById('downloadBtn').onclick = () => { window.location.href = link; };
          statusBar.textContent = '任务已完成，可下载结果文件。';
        } else {
          actionArea.innerHTML = `<button class="btn" id="refreshBtn">刷新</button>`;
          document.getElementById('refreshBtn').onclick = () => { location.reload(); };
          statusBar.textContent = isTimeout ? '状态超时，建议重试或联系支持。' : '任务处理中，可稍后刷新查看最新状态。';
        }

      } catch (err) {
        statusBar.innerHTML = `<span style="color:#fca5a5">网络异常：${escapeHtml(err.message || String(err))}</span>`;
        actionArea.innerHTML = `<button class="btn secondary" onclick="location.reload()">刷新</button>`;
      } finally {
        setLoading(false);
      }
    }

    function getStateInfo(status, isTimeout){
      if (isTimeout) return { text: '超时', cls: 'timeout' };
      switch (Number(status)) {
        case 1: return { text: '提取词条中', cls: 'wait' };
        case 2: return { text: '翻译中', cls: 'ing' };
        case 3: return { text: '打包中', cls: 'pack' };
        case 0: return { text: '完成', cls: 'done' };
        default: return { text: '未知', cls: 'ing' };
      }
    }

    function renderNamespaces(list){
      if (!Array.isArray(list) || list.length === 0) return '—';
      return list.map(x => `<span class="badge">${escapeHtml(String(x))}</span>`).join('');
    }

    function clearTable(){
      tdStatus.textContent = '—';
      tdNamespaces.textContent = '—';
      tdStrings.textContent = '—';
    }

    function setLoading(loading, text){
      if (loading) {
        statusBar.innerHTML = `<span class="spinner"></span>${escapeHtml(text || '加载中...')}`;
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
  </script>
</body>
</html>